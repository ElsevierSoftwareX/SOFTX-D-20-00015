\documentclass[12pt, a4paper, openany]{memoir}
\usepackage[top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm]{geometry}
\usepackage{listings}
\usepackage{color}
%\usepackage{algorithm2e}
%\usepackage{algpseudocode}
\usepackage{graphicx}
\usepackage[none]{hyphenat}
\usepackage{csvsimple}
%\usepackage{placeins}
\usepackage{chngcntr}
\usepackage{amsmath} %matrix
\usepackage{indentfirst} %indent the first paragraph after new section
%\usepackage[style=authoryear]{biblatex}
\usepackage{tikz} % flowchart
\usetikzlibrary{shapes,arrows} % flowchart
\usepackage{hyperref} % links
\usepackage{subcaption}
\usepackage[section,above,below]{placeins} % floatbarrier em tudo?
%\usepackage{fancyhdr}
%\pagestyle{fancy} 
%\fancyhf{}

\setsecnumdepth{subsection} %show number in subsection
\maxtocdepth{subsection} %show subsection in toc

\newcommand{\norm}[1]{\left\lVert#1\right\rVert}


\title{ \normalsize \textsc{Master 1 - Final year project}
	\\ [2.0cm]
	\hrule
	\vspace{0.5cm}
	\LARGE \textbf{\uppercase{Coherent structure detection and fitting in turbulent flows}} \\ [0.5cm]
	\hrule
	\vspace{0.5cm}
	\normalsize  \vspace*{5\baselineskip}}


\date{\vfill May - 2017}

\author{
	\Large Guilherme Lindner \\ [1.0cm]
	Research Advisors: \\
	Jean Marc Foucaut \\
	Jean-Philippe Laval  \\ [1.0cm]
	International Master on Turbulence\\ [0.2cm]
	Ecole Centrale, Lille \\}

\begin{document}
	
	\maketitle
	\thispagestyle{empty}
	\let\cleardoublepage\clearpage
	\frontmatter
	\begin{abstract}
		In this project, a tool is developed in Python to detect and evaluate the coherent structures of a velocity field.
		This tool comprehends the reading of NetCDF files and applying a method for detecting the vortices, like swirling strength of Q criterion. After this, all the vortices found are fitted to the Lamb-Oseen vortex using the Levenberg-Marquardt non-linear least squares method and the correlation between the model and original data is evaluated. If the correlation is higher than 0.75, the vortex is accepted, otherwise is reject. The analyzed data can come from Direct Numerical Simulation (DNS) or Particle Image Velocimetry (PIV).
	\end{abstract}
	\newpage
	\tableofcontents
	\newpage
%	\thispagestyle{empty}
	\listoftables
	\newpage
	\listoffigures

    \mainmatter

\chapter*{Introduction}
\addcontentsline{toc}{chapter}{Introduction} %\markboth{INTRODUCTION}{}
here is all the introduction

Explain Coherent structures


\chapter{Methodology}

\section{Detection methods}
In this section, the detection methods implemented in the code for vortex identification are presented. These methods are based on the velocity gradient tensor, $\overline{D}$, that can be written as:

\begin{equation}
D_{ij} = \frac{\partial u_i}{\partial x_i}
\end{equation}

As this is a second order tensor, it can be decomposed into a symmetric and anti-symmetric part, $D_{ij} = S_{ij} + \Omega_{ij}$ where:

\begin{equation}
S_{ij} = \frac{1}{2} \left(\frac{\partial u_i}{\partial x_j} + \frac{\partial u_j}{\partial x_i}\right)
\end{equation}

\begin{equation}
\Omega_{ij} = \frac{1}{2} \left(\frac{\partial u_i}{\partial x_j} - \frac{\partial u_j}{\partial x_i}\right)
\end{equation}
$S_{ij}$ is known as the rate-of-strain tensor and $\Omega_{ij}$ is the vorticity tensor.

The characteristic equation for $\nabla u$ is given by

\begin{equation}
\lambda^3 + P \lambda^2 + Q \lambda + R = 0
\end{equation}
where P, Q and R are the three invariants of the velocity gradient tensor. Using the decomposition into symmetric and anti-symmetric parts, these invariants can be expressed as:
\begin{equation}
P = -tr(\bar{D})
\end{equation}

\begin{equation}
Q = \frac{1}{2} (tr(\bar{D})^2 -tr(\bar{D}^2)) = \frac{1}{2} (\norm{\Omega}^2 - \norm{S}^2)
\end{equation}

\begin{equation}
R = -det(\bar{D})
\end{equation}

\subsection{Q criterion}

The Q criterion proposed by Hung \textit{et al} (1988) identifies the vortices as flow regions with positive second invariant of $\nabla u$. An additional condition is that the pressure in the eddy region should to be lower than the ambient pressure. Chakraborty \textit{et al}(2005) \cite{chakra2005} quoted "in an incompressible flow Q is a local measure of the excess rotation rate relative to the strain rate".

In practical terms, the vortex is detected in case of the second invariant $Q > 0$.

\subsection{$\Delta$ criterion}

Chong \textit{et al} (1990) \cite{chong1990} define a vortex core to be the region where $\nabla v$ has complex eigenvalues. In order to determine if the eigenvalues are complex, we examine the discriminant of the characteristic equation, considering the flow incompressible (P = 0).

\begin{equation}
\Delta = \left(\frac{Q}{3}\right)^3 + \left(\frac{R}{2}\right)^2 > 0
\end{equation}


\subsection{Swirling strength criterion}

The swirling strength criterion ($\lambda_{ci}$) was developed by Zhou \textit{et al} (1999) \cite{zhou1999}. It defines a vortex core to be the region where $\nabla v$ has complex eigenvalues. It is based on the idea that the velocity gradient tensor in Cartesian coordinates can be decomposed as:

\begin{equation}
\nabla u = [\bar{\nu_r} \bar{\nu_{cr}} \bar{\nu_{ci}}]^T
\left[\begin{array}{ccc}
\lambda_r & 0 & 0 \\
0 & \lambda_{cr} & \lambda{ci} \\
0 & -\lambda{ci} & \lambda{cr} \end{array}\right]
[\bar{\nu_r} \bar{\nu_{cr}} \bar{\nu_{ci}}]^T
\end{equation} 
where $\lambda_r$ is the real eigenvalue, related to the eigenvector $\bar{\nu_r}$, and the complex conjugate pair of complex eigenvalues is $\lambda_{cr}  \pm i\lambda_{ci}$, related to the eigenvectors $\bar{\nu_r} \pm i\bar{\nu_{ci}}$. The strength of this swirling motion can be quantified by $\lambda_{ci}$ , called the local swirling strength of the vortex. The threshold for $\lambda_{ci}$ is not well-defined, but theoretically any value greater than zero should be considered a vortex. Experimental results \cite{zhou1999} shows that $\lambda_{ci} \geq \epsilon > 0$ give smoother results.

\section{Derivative scheme}
Two schemes were selected to be implemented, the 2nd order scheme and the 4th order scheme. The stencils are presented below.

Second order central differencing scheme
\begin{equation}
F_x(i) = \frac{F(i+1)-F(i-1)}{2 \Delta x}
\end{equation}

Fourth order accurate
\begin{equation}
F_x(i) = \frac{-F(i+2)+8F(i+1)-8F(i-1)+F(i-2)}{12 \Delta x}
\end{equation}

left edge cells
\begin{equation}
F_x(i) = \frac{F(i+3)-6F(i+2)+18F(i+1)-10F(i) -3F(i-1)}{12 \Delta x}
\end{equation}

right edge cells
\begin{equation}
F_x(i) = \frac{3F(i+1)+10F(i)-18F(i-1)+6F(i-2) -F(i-3)}{12 \Delta x}
\end{equation}


According to Raffel \textit{et al} (1998), the 2nd order scheme is recommended because it minimizes the propagation of measurement noise. 

\section{Localization of the extrema}

To have smooth results on the swirling strength, we apply a normalization of the field. The swirling strength is divided by the wall-normal profile of its RMS value:

\begin{equation}
\bar{\lambda}_{ci}(x_{1/3},x_2) = \frac{\lambda_{ci}(x_{1/3},x_2)}{\lambda_{ci,RMS}(x_2)}
\end{equation}

Then the local maxima of the detection can be identified. The normalization is not required for the HIT cases, it is only used when we have an non-homogeneous direction.

\begin{figure}[h]
	\centering
	\includegraphics[trim=0 130 0 130 ,clip, width=\textwidth]{figure/PIVnonnormalized.pdf}
	\caption{Original swirling strength field}
	\label{fig:nonnorm}
\end{figure}

\begin{figure}[h]
	\centering
	\includegraphics[trim=0 130 0 130 , clip, width=\textwidth]{figure/PIVnormalized.pdf}
	\caption{Normalized swirling strength field}
	\label{fig:norm}
\end{figure}

In figure \ref{fig:nonnorm} we see the original swirling strength field, where 104 vortices were found mostly near the wall. In figure \ref{fig:norm} we show the normalized swirling strength field, now with 202 vortices found. 

\section{Fitting of coherent structures}

The correlation coefficient between the fitted model and the velocity field is calculated according to equation.

\begin{equation}
R(model/data) = \left( \frac{\langle (\vec{u}_{data}-\vec{u}_c).(\vec{u}_{model}-\vec{u}_c)\rangle }
{\sqrt{\langle (\vec{u}_{data}-\vec{u}_c)^2\rangle} \sqrt{\langle (\vec{u}_{model}-\vec{u}_c)^2\rangle}} \right)^{1/2}
\end{equation}

\subsection{Lamb-Oseen vortex}

The Lamb-Oseen vortex is a mathematical model for the flow velocity in the circumferential direction ($\theta$), shown in equation \ref{eq:oseenDecay}. It models a line vortex that decays due to viscosity.

\begin{equation}
\label{eq:oseenDecay}
\vec{u}_\theta(r,t) = \frac{\Gamma}{2\pi r} \left( 1 - exp \left( -\left(\frac{r}{r_0(t)}\right)^2\right)\right) \vec{e}_{\theta}
\end{equation}
where $r$ is the radius, $r_0 = \sqrt{4 \nu t}$ is the core radius of vortex, $\nu$ is the viscosity and $\Gamma$ is the circulation contained in the vortex. 

In this work we are dealing with a time-independent flow, so we have no decaying due to viscosity. And since the coherent structures are in movement, we add the convective velocity to the Lamb-Oseen vortex model shown in equation \ref{eq:oseen}.  

\begin{equation}
\label{eq:oseen}
\vec{u}(r,\theta) = \vec{u}_c + \frac{\Gamma}{2\pi r} \left( 1 - exp \left( -\left(\frac{r}{r_0}\right)^2\right)\right) \vec{e}_{\theta}
\end{equation}

\subsection{Non-linear least squares}

Levenberg Marquardt method
\begin{equation}
\chi^2 = \sum_{i=1}^N \left[ \frac{y_i - \sum_{k=1}^M a_k X_k (x_i)}{\sigma i} \right]^2
\end{equation}

\begin{equation}
\alpha_{kl} = \sum_{i=1}^N \frac{1}{\sigma_i^2} \left[ \frac{\partial y(x_i;a)}{\partial a_k} \frac{\partial y(x_i;a)}{\partial a_l} \right]
\end{equation}

\section{Programming}

The language chosen for developing the detection tools is Python 3.6 (Python Software Foundation, https://www.python.org/). This choice was made for the following reasons:
\begin{itemize}
	\item Readability \\
	Python's syntax is easy to read, very close to pseudocode itself.
	\item Access to low level programming languages \\
	We can easily add C or Fortran code o be run inside Python's code, reusing some useful libraries and tools.
	\item Language interoperability \\
	MATLAB functions can be called from Python through the MATLAB engine and even other languages.
	\item Documentation system \\
	One helpful feature for scientific programming is the ability to put LaTeX equations and plots directly in code documentation, by using the docstrings.
	\item Available libraries \\
	Python has an impressive standard library packaged with Python. For scientific uses, the most well known are NumPy and SciPy.
\end{itemize} 

\subsection{Code Structure}

The following files are present on the code, allowing the easy implementation of new methods, tools or scheemes.

\begin{itemize}
	\item classes.py : definition of the data type, i.e. DNS, PIV, ...
	\item detection.py : detect the vortices by one of the methos (Q criterion, $\lambda_2$ criterion or swirling strenth)
	\item fitting.py : performs the fit to oseen vortex
	\item plot.py : plot the desired results, like scalar fiels, vectors, ...
	\item schemes.py : differencing schemes (2nd and 4th order)
	\item testoseen.py : tests for fitting performance
	\item tools.py : normalization, vortex window definition, local maxima detection, ... 
	\item vortexfitting.py : main program
\end{itemize}

The code uses the version control system Git, and it's hosted and fully available at \url{https://github.com/guilindner/VortexFitting}. 


\chapter{Validation}
In this chapter we will use some controlled cases to test the overall performance of the code.

\section{Detection}
Here we will test the three detection methods, Q criterion, $\Delta$ criterion and swirling strength.  


\begin{table}[h]
	\centering
	\caption{Vortices found, detection X schemes}
	\vspace{10px}
	\label{tb:detection}
	\begin{tabular}{l|l|l}
		         & 2nd order      & 4th order  \\
		\hline
		Q criterion  & 111  & 111  \\
		$\lambda_2$ criterion & 111  & 111 \\
		Swirling strength    & 111  & 111
	\end{tabular}
\end{table}

\section{Fitting}

\begin{figure}[h!]
	\centering
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_02_10.pdf}
		\caption{r = 0.2, Gamma = 10}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_02_10_02.pdf}
		\caption{r = 0.2, Gamma = 10, shift = 0.2}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_09_40.pdf}
		\caption{r = 0.9, Gamma = 40}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_09_40_02.pdf}
		\caption{r = 0.9, Gamma = 40, shift = 0.2}
	\end{subfigure}
	\caption{Fitting test}
	\label{fig:fittingtests}
\end{figure}

\begin{table}[h]
	\centering
	\caption{Fitting test parameters}
	\vspace{10px}
	\label{tb:fittingtest}
	\begin{tabular}{l|l|l|l|l}
		            & 1      & 2 & 3 & 4 \\
		\hline
		radius      & 0.2284   & 0.2305 & 0.8965 & 0.9003  \\
		gamma       & 11.3971 & 11.4534 & 42.0690 & 42.2732 \\
		x shift     & 0.0000  & 0.1969 & 0.0000 & 0.1964 \\
		y shift     & 0.0000  & 0.2021 & 0.0000 & 0.2033 \\ 
		correlation & 0.9998   & 0.9998 & 0.9999 & 0.9999 \\
	\end{tabular}
\end{table}

Now with noise:

\begin{figure}[h!]
	\centering
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_02_10N.pdf}
		\caption{r = 0.2, Gamma = 10}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_02_10_02N.pdf}
		\caption{r = 0.2, Gamma = 10, shift = 0.2}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_09_40N.pdf}
		\caption{r = 0.9, Gamma = 40}
	\end{subfigure}
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[trim=40 20 40 20 ,clip, width=\textwidth]{figure/test_09_40_02N.pdf}
		\caption{r = 0.9, Gamma = 40, shift = 0.2}
	\end{subfigure}
	\caption{Fitting test with random noise}
	\label{fig:fittingtestsnoise}
\end{figure}

\begin{table}[h]
	\centering
	\caption{Fitting test parameters with noise}
	\vspace{10px}
	\label{tb:fittingtestnoise}
	\begin{tabular}{l|l|l|l|l}
		& 1      & 2 & 3 & 4 \\
		\hline
		radius      & 0.2503   & 0.2140 & 0.9071 & 0.8953  \\
		gamma       & 11.658 & 11.2872 & 42.7391 & 42.4328 \\
		x shift     & 0.0068  & 0.1977 & 0.0003 & 0.2017 \\
		y shift     & 0.0077  & 0.2123 & 0.0134 & 0.2042 \\ 
		correlation & 0.9889   & 0.9904 & 0.9873 & 0.9879 \\
	\end{tabular}
\end{table}


\chapter{Results}
Here we show the results of the full fitting procedure of DNS data and PIV data.

\section{DNS data}
This case is an homogeneous isotropic turbulence (HIT) study. The data is generated by the ...

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.5]{figure/dummy.png}
	\caption{Detected vortices from the DNS data}
	\label{fig:detectionDNS}
\end{figure}

In figure \ref{fig:detectionDNS}, the yellow circles corresponds to the detected vortices rotating clockwise and the green circles for the counter-clockwise rotation.

\begin{figure}[h!]
	\centering
	\begin{subfigure}[b]{0.4\textwidth}
		\centering
		\includegraphics[width=\textwidth]{figure/dummy.png}
		\caption{Lorem ipsum}
	\end{subfigure}
	\begin{subfigure}[b]{0.4\textwidth}
		\centering
		\includegraphics[width=\textwidth]{figure/dummy.png}
		\caption{Lorem ipsum}
	\end{subfigure}
	\begin{subfigure}[b]{0.4\textwidth}
		\centering
		\includegraphics[width=\textwidth]{figure/dummy.png}
		\caption{Lorem ipsum}
	\end{subfigure}
	\begin{subfigure}[b]{0.4\textwidth}
		\centering
		\includegraphics[width=\textwidth]{figure/dummy.png}
		\caption{Lorem ipsum}
	\end{subfigure}
	\caption{all}
	\label{fig:vorticesDNS}
\end{figure}

Figure \ref{fig:vorticesDNS} shows 4 random fitted vortices from the DNS, and table \ref{tb:DNSvortices} describes its characteristics.

\begin{table}[h]
	\centering
	\caption{DNS vortices characteristics}
	\vspace{10px}
	\label{tb:DNSvortices}
	\begin{tabular}{l|l|l|l|l|l}
		Vortex         & Center(x,y) & $\Gamma$    & core radius   & correlation & mesh window \\
		\hline
		a  & 9.36  & 12.90  & 9.61 &  8.56 & 2 \\
		b      & 9.36  & 25.81  & 38.55& 66.45 & 2 \\
		c    & 1.00  & 0.73   & 0.97 & 1.09 & 2\\
		d    & 22   &   22   &   321 & 2 & 2
	\end{tabular}
\end{table}
  

\section{PIV data}

\begin{figure}[h]
	\centering
	\label{fig:detectionPIV}
	\includegraphics[scale=0.5]{figure/dummy.png}
	\caption{Detected vortices from the PIV data}
\end{figure}

\section{test citation}
According to \cite{herpin2009} and \cite{raoul2016}.





\newpage
\bibliographystyle{plain}
\bibliography{biblio}

\appendix

%\chapter{Finite difference methods}
%\section{Finite difference methods}




\end{document}














